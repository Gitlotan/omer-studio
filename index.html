<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Omer Studio — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#FAFAF8;--sidebar-bg:#1A1A1A;--sidebar-text:#B8B8B0;--sidebar-active:#FFF;
  --card-bg:#FFF;--card-border:#ECECEA;--text-primary:#1A1A1A;--text-secondary:#6B6B63;--text-muted:#9B9B93;
  --accent:#C4956A;--accent-soft:#F5EDE3;
  --success:#5B8C5A;--success-soft:#EDF5ED;--warning:#D4A843;--warning-soft:#FBF4E4;
  --info:#5B7B9C;--info-soft:#EDF2F7;
  --tag-marketing:#7B68A5;--tag-marketing-soft:#F0EDF5;
  --tag-creative:#C4956A;--tag-creative-soft:#F5EDE3;
  --tag-finance:#5B8C5A;--tag-finance-soft:#EDF5ED;
  --tag-strategy:#5B7B9C;--tag-strategy-soft:#EDF2F7;
  --shadow-md:0 4px 12px rgba(0,0,0,.06);--radius:12px;--radius-sm:8px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text-primary);display:flex;height:100vh;overflow:hidden;font-size:14px}

.ic{display:inline-flex;align-items:center;justify-content:center;flex-shrink:0}
.ic svg{width:18px;height:18px;stroke-width:1.75;fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round}
.ic-sm svg{width:15px;height:15px}.ic-lg svg{width:20px;height:20px}.ic-xl svg{width:28px;height:28px}

/* Sidebar */
.sidebar{width:260px;min-width:260px;background:var(--sidebar-bg);display:flex;flex-direction:column;overflow-y:auto}
.sidebar-logo{padding:28px 24px 20px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:12px}
.sidebar-logo .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),#D4A843);border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:#fff}
.sidebar-logo .logo-text{color:#fff;font-size:16px;font-weight:600;letter-spacing:-.3px}
.sidebar-logo .logo-sub{color:var(--sidebar-text);font-size:11px;margin-top:1px}
.sidebar-section{padding:20px 16px 8px}
.sidebar-section-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:rgba(255,255,255,.25);padding:0 8px 10px}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--radius-sm);color:var(--sidebar-text);cursor:pointer;transition:all .15s;font-size:13.5px;margin-bottom:2px}
.sidebar-item:hover{background:rgba(255,255,255,.06);color:var(--sidebar-active)}
.sidebar-item.active{background:rgba(255,255,255,.1);color:var(--sidebar-active);font-weight:500}
.sidebar-item .badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-weight:600;padding:2px 7px;border-radius:10px}
.sidebar-spacer{flex:1}
.sidebar-user{padding:16px 20px;border-top:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px}
.sidebar-user .avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#D4A843);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:13px}
.sidebar-user .user-info{color:var(--sidebar-text);font-size:12px}
.sidebar-user .user-name{color:#fff;font-weight:500;font-size:13px}

/* Main */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:60px;border-bottom:1px solid var(--card-border);background:#fff;display:flex;align-items:center;padding:0 32px;gap:16px;flex-shrink:0}
.topbar-breadcrumb{font-size:13px;color:var(--text-muted)}
.topbar-breadcrumb span{color:var(--text-primary);font-weight:500}
.topbar-spacer{flex:1}
.topbar-search{display:flex;align-items:center;gap:8px;background:var(--bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:7px 14px;font-size:13px;color:var(--text-muted);cursor:pointer;transition:border-color .15s}
.topbar-search:hover{border-color:var(--accent)}
.topbar-btn{width:36px;height:36px;border-radius:var(--radius-sm);border:1px solid var(--card-border);background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary);transition:all .15s}
.topbar-btn:hover{border-color:var(--accent);color:var(--accent)}

.content{flex:1;overflow-y:auto;padding:28px 32px}
.page-header{margin-bottom:28px}
.page-header h1{font-family:'Playfair Display',serif;font-size:28px;font-weight:600;letter-spacing:-.5px;margin-bottom:6px}
.page-header p{color:var(--text-secondary);font-size:14px}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;height:200px;color:var(--text-muted);font-size:14px;gap:10px}
.spinner{width:20px;height:20px;border:2px solid var(--card-border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Stats */
.dash-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:28px}
.stat-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:22px;transition:all .2s}
.stat-card:hover{box-shadow:var(--shadow-md);border-color:transparent}
.stat-icon{width:36px;height:36px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;margin-bottom:14px}
.stat-icon.blue{background:var(--info-soft);color:var(--info)}
.stat-icon.green{background:var(--success-soft);color:var(--success)}
.stat-icon.warm{background:var(--accent-soft);color:var(--accent)}
.stat-label{font-size:12px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.stat-value{font-family:'Playfair Display',serif;font-size:32px;font-weight:600;margin-bottom:6px}
.stat-change{font-size:12px;color:var(--text-muted)}

/* Project cards */
.projects-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:28px}
.project-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:22px;cursor:pointer;transition:all .2s}
.project-card:hover{box-shadow:var(--shadow-md);border-color:transparent;transform:translateY(-1px)}
.project-card-header{display:flex;align-items:flex-start;gap:14px;margin-bottom:12px}
.project-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.project-icon.strategy{background:var(--tag-strategy-soft);color:var(--tag-strategy)}
.project-icon.marketing{background:var(--tag-marketing-soft);color:var(--tag-marketing)}
.project-icon.creative{background:var(--tag-creative-soft);color:var(--tag-creative)}
.project-icon.finance{background:var(--tag-finance-soft);color:var(--tag-finance)}
.project-tag{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.project-tag.strategy{background:var(--tag-strategy-soft);color:var(--tag-strategy)}
.project-tag.marketing{background:var(--tag-marketing-soft);color:var(--tag-marketing)}
.project-tag.creative{background:var(--tag-creative-soft);color:var(--tag-creative)}
.project-tag.finance{background:var(--tag-finance-soft);color:var(--tag-finance)}
.project-card h3{font-size:15px;font-weight:600;margin-bottom:4px;letter-spacing:-.2px}
.project-desc{font-size:13px;color:var(--text-secondary);line-height:1.5;margin-bottom:16px}
.project-footer{display:flex;align-items:center;justify-content:space-between}
.project-progress{flex:1;margin-right:16px}
.progress-bar{height:4px;background:var(--bg);border-radius:4px;overflow:hidden;margin-bottom:4px}
.progress-bar .fill{height:100%;border-radius:4px;transition:width .6s}
.progress-label{font-size:11px;color:var(--text-muted)}

/* Section headers */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.section-header h2{font-size:18px;font-weight:600;letter-spacing:-.3px}
.view-all{font-size:13px;color:var(--accent);cursor:pointer;font-weight:500}
.view-all:hover{text-decoration:underline}

/* Task list */
.task-list{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);overflow:hidden}
.task-row{display:flex;align-items:center;padding:14px 20px;gap:14px;border-bottom:1px solid var(--card-border);transition:background .1s;cursor:pointer}
.task-row:last-child{border-bottom:none}
.task-row:hover{background:var(--bg)}
.task-check{width:18px;height:18px;border-radius:50%;border:2px solid var(--card-border);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s}
.task-row:hover .task-check{border-color:var(--accent)}
.task-check.done{background:var(--success);border-color:var(--success)}
.task-info{flex:1}
.task-name{font-size:13.5px;font-weight:500;margin-bottom:2px}
.task-name.completed{text-decoration:line-through;color:var(--text-muted)}
.task-meta{font-size:11.5px;color:var(--text-muted)}
.task-assignee{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:#fff}
.task-status{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:500}
.task-status.in-progress{background:var(--warning-soft);color:var(--warning)}
.task-status.todo{background:var(--bg);color:var(--text-muted)}
.task-status.done{background:var(--success-soft);color:var(--success)}
.task-status.review{background:var(--info-soft);color:var(--info)}
.task-due{font-size:12px;color:var(--text-muted);min-width:70px;text-align:right}

/* Screens */
.screen{display:none}.screen.active{display:block}

/* Empty state */
.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}
.empty-state h3{font-size:16px;font-weight:500;margin-bottom:8px;color:var(--text-secondary)}
.empty-state p{font-size:13px}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;border:none;font-family:inherit}
.btn-primary{background:var(--sidebar-bg);color:#fff}.btn-primary:hover{background:#333}

/* Tab nav */
.tab-nav{display:flex;border-bottom:1px solid var(--card-border);margin-bottom:24px}
.tab-item{padding:10px 20px;font-size:13px;font-weight:500;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s}
.tab-item:hover{color:var(--text-primary)}
.tab-item.active{color:var(--text-primary);border-bottom-color:var(--accent)}

/* Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.content>*{animation:fadeIn .3s ease}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--card-border);border-radius:3px}
</style>
</head>
<body>

<!-- SVG Icons -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <symbol id="i-layout" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></symbol>
  <symbol id="i-compass" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></symbol>
  <symbol id="i-store" viewBox="0 0 24 24"><path d="M3 9l1-4h16l1 4"/><path d="M3 9v11a1 1 0 001 1h16a1 1 0 001-1V9"/><path d="M9 21V13h6v8"/></symbol>
  <symbol id="i-cpu" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M9 1v3M15 1v3M9 20v3M15 20v3M20 9h3M20 14h3M1 9h3M1 14h3"/></symbol>
  <symbol id="i-map" viewBox="0 0 24 24"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></symbol>
  <symbol id="i-image" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></symbol>
  <symbol id="i-zap" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></symbol>
  <symbol id="i-wallet" viewBox="0 0 24 24"><path d="M20 12V8H6a2 2 0 01-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12a2 2 0 002 2h14v-4"/><circle cx="18" cy="14" r="1"/></symbol>
  <symbol id="i-megaphone" viewBox="0 0 24 24"><path d="M3 11l18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 11-5.8-1.6"/></symbol>
  <symbol id="i-package" viewBox="0 0 24 24"><path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></symbol>
  <symbol id="i-drive" viewBox="0 0 24 24"><path d="M22 12h-6l-2 3h-4l-2-3H2"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></symbol>
  <symbol id="i-settings" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></symbol>
  <symbol id="i-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></symbol>
  <symbol id="i-bell" viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></symbol>
  <symbol id="i-plus" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
  <symbol id="i-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></symbol>
  <symbol id="i-folder" viewBox="0 0 24 24"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></symbol>
  <symbol id="i-check-circle" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></symbol>
</svg>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">O</div>
    <div><div class="logo-text">Omer Studio</div><div class="logo-sub">Creative Business</div></div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-label">Overview</div>
    <div class="sidebar-item active" onclick="nav('dashboard',this)"><span class="ic"><svg><use href="#i-layout"/></svg></span> Dashboard</div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-label">Projects</div>
    <div id="sidebar-projects"></div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-label">Phase 2 (Soon)</div>
    <div class="sidebar-item" style="opacity:.35;pointer-events:none"><span class="ic"><svg><use href="#i-wallet"/></svg></span> Finance</div>
    <div class="sidebar-item" style="opacity:.35;pointer-events:none"><span class="ic"><svg><use href="#i-megaphone"/></svg></span> Marketing</div>
    <div class="sidebar-item" style="opacity:.35;pointer-events:none"><span class="ic"><svg><use href="#i-package"/></svg></span> Inventory</div>
  </div>
  <div class="sidebar-spacer"></div>
  <div class="sidebar-section">
    <div class="sidebar-item"><span class="ic"><svg><use href="#i-drive"/></svg></span> Google Drive</div>
    <div class="sidebar-item"><span class="ic"><svg><use href="#i-settings"/></svg></span> Settings</div>
  </div>
  <div class="sidebar-user">
    <div class="avatar">L</div>
    <div class="user-info"><div class="user-name">Lotan & Omer</div><div>Workspace</div></div>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-breadcrumb">Omer Studio <span style="margin:0 6px;color:var(--text-muted)">›</span> <span id="bc">Dashboard</span></div>
    <div class="topbar-spacer"></div>
    <div class="topbar-search"><span class="ic ic-sm"><svg><use href="#i-search"/></svg></span> Search anything...</div>
    <div class="topbar-btn"><span class="ic"><svg><use href="#i-bell"/></svg></span></div>
    <div class="topbar-btn"><span class="ic"><svg><use href="#i-plus"/></svg></span></div>
  </div>

  <div class="content">
    <!-- DASHBOARD -->
    <div class="screen active" id="s-dashboard">
      <div class="page-header"><h1>Good morning</h1><p>Here's what's happening across Omer's business today</p></div>
      <div class="dash-grid" id="stats-grid">
        <div class="stat-card"><div class="stat-icon blue"><span class="ic ic-lg"><svg><use href="#i-folder"/></svg></span></div><div class="stat-label">Active Projects</div><div class="stat-value" id="stat-projects">—</div><div class="stat-change">Loading...</div></div>
        <div class="stat-card"><div class="stat-icon green"><span class="ic ic-lg"><svg><use href="#i-check-circle"/></svg></span></div><div class="stat-label">Open Tasks</div><div class="stat-value" id="stat-tasks">—</div><div class="stat-change" id="stat-tasks-done"></div></div>
        <div class="stat-card"><div class="stat-icon warm"><span class="ic ic-lg"><svg><use href="#i-image"/></svg></span></div><div class="stat-label">Reference Items</div><div class="stat-value" id="stat-refs">—</div><div class="stat-change" id="stat-refs-info"></div></div>
      </div>
      <div class="section-header"><h2>Projects</h2></div>
      <div class="projects-grid" id="projects-grid">
        <div class="loading"><div class="spinner"></div> Loading projects from Google Sheets...</div>
      </div>
      <div class="section-header"><h2>Recent Tasks</h2><span class="view-all">View all →</span></div>
      <div id="tasks-list">
        <div class="loading"><div class="spinner"></div> Loading tasks...</div>
      </div>
    </div>

    <!-- PROJECT DETAIL (dynamic) -->
    <div class="screen" id="s-project">
      <div class="page-header"><h1 id="project-title"></h1><p id="project-desc"></p></div>
      <div class="tab-nav">
        <div class="tab-item active">Tasks</div>
        <div class="tab-item">Files</div>
      </div>
      <div class="section-header"><h2>Tasks</h2></div>
      <div id="project-tasks"></div>
    </div>
  </div>
</div>

<script>
// ============================================
// CONFIG
// ============================================
const SHEET_ID = '1x4muffjvZhrdbvsrBdTgkloo441-y1ThYGsgKKaT3mc';

// Sheet GIDs — update these after checking your sheet
// Default GIDs for sheets created in order: 0, then auto-generated
// You can find GIDs in the URL when clicking each tab: #gid=XXXXX
const SHEET_GIDS = {
  Projects: 997517085,
  Tasks: 1481389517,
  References: 1244683688,
  Platforms: 1804897256,
  Tools: 436378319,
  Skills: 2054960753
};

// Icon mapping
const ICONS = {
  compass:'#i-compass', store:'#i-store', cpu:'#i-cpu', map:'#i-map',
  image:'#i-image', zap:'#i-zap', folder:'#i-folder', default:'#i-folder'
};

// Color mapping
const COLORS = {
  strategy:'strategy', marketing:'marketing', creative:'creative',
  finance:'finance', revenue:'marketing', tools:'creative',
  research:'creative', development:'finance', planning:'strategy'
};

// ============================================
// DATA FETCHING
// ============================================
let DATA = { projects:[], tasks:[], references:[], platforms:[], tools:[], skills:[] };

function parseCSV(text) {
  if (!text || !text.trim()) return [];
  const lines = [];
  let current = '';
  let inQuotes = false;
  // Split into lines respecting quoted newlines
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') { inQuotes = !inQuotes; current += ch; }
    else if ((ch === '\n' || ch === '\r') && !inQuotes) {
      if (current.trim()) lines.push(current);
      current = '';
      if (ch === '\r' && text[i+1] === '\n') i++;
    } else { current += ch; }
  }
  if (current.trim()) lines.push(current);
  if (lines.length < 1) return [];

  function splitCSVLine(line) {
    const fields = [];
    let field = '';
    let inQ = false;
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"') {
        if (inQ && line[i+1] === '"') { field += '"'; i++; }
        else inQ = !inQ;
      } else if (c === ',' && !inQ) { fields.push(field); field = ''; }
      else field += c;
    }
    fields.push(field);
    return fields;
  }

  const headers = splitCSVLine(lines[0]);
  return lines.slice(1).map(line => {
    const values = splitCSVLine(line);
    const obj = {};
    headers.forEach((h, i) => { obj[h] = values[i] || ''; });
    return obj;
  });
}

async function fetchSheet(sheetName) {
  try {
    // Method 1: Try gviz JSONP endpoint
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    return parseCSV(text);
  } catch(e1) {
    try {
      // Method 2: Try published CSV with GID
      const gid = SHEET_GIDS[sheetName];
      if (gid !== null && gid !== undefined) {
        const url2 = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
        const res2 = await fetch(url2);
        if (!res2.ok) throw new Error(`HTTP ${res2.status}`);
        const text2 = await res2.text();
        return parseCSV(text2);
      }
      throw e1;
    } catch(e2) {
      console.error(`Error fetching ${sheetName}:`, e2);
      return [];
    }
  }
}

async function loadAllData() {
  const [projects, tasks, references, platforms, tools, skills] = await Promise.all([
    fetchSheet('Projects'),
    fetchSheet('Tasks'),
    fetchSheet('References'),
    fetchSheet('Platforms'),
    fetchSheet('Tools'),
    fetchSheet('Skills')
  ]);
  DATA = { projects, tasks, references, platforms, tools, skills };
  renderDashboard();
}

// ============================================
// RENDERING
// ============================================
function getColorClass(cat) {
  if (!cat) return 'strategy';
  const lower = cat.toLowerCase();
  return COLORS[lower] || 'strategy';
}

function getIcon(iconName) {
  if (!iconName) return ICONS.default;
  return ICONS[iconName] || ICONS.default;
}

function renderDashboard() {
  // Stats
  const activeProjects = DATA.projects.filter(p => p.status === 'Active').length || DATA.projects.length;
  const openTasks = DATA.tasks.filter(t => t.status !== 'Done').length;
  const doneTasks = DATA.tasks.filter(t => t.status === 'Done').length;
  const refCount = DATA.references.length;

  document.getElementById('stat-projects').textContent = activeProjects || '0';
  document.getElementById('stat-tasks').textContent = openTasks || '0';
  document.getElementById('stat-tasks-done').textContent = doneTasks ? `${doneTasks} completed` : 'No tasks yet';
  document.getElementById('stat-refs').textContent = refCount || '0';
  document.getElementById('stat-refs-info').textContent = refCount ? `${refCount} items collected` : 'No references yet';

  // Projects grid
  const grid = document.getElementById('projects-grid');
  if (DATA.projects.length === 0) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
      <h3>No projects yet</h3>
      <p>Add your first project in the Google Sheet → Projects tab</p>
    </div>`;
  } else {
    grid.innerHTML = DATA.projects.map(p => {
      const color = getColorClass(p.color || p.category);
      const icon = getIcon(p.icon);
      const projectTasks = DATA.tasks.filter(t => t.project_id === p.id);
      const doneTasks = projectTasks.filter(t => t.status === 'Done').length;
      const progress = p.progress || (projectTasks.length ? Math.round(doneTasks/projectTasks.length*100) : 0);
      const remaining = projectTasks.length - doneTasks;
      return `<div class="project-card" onclick="showProject('${p.id}')">
        <div class="project-card-header">
          <div class="project-icon ${color}"><span class="ic ic-lg"><svg><use href="${icon}"/></svg></span></div>
          <div>
            <span class="project-tag ${color}">${p.category || 'Project'}</span>
            <h3>${p.name}</h3>
          </div>
        </div>
        <p class="project-desc">${p.description || ''}</p>
        <div class="project-footer">
          <div class="project-progress">
            <div class="progress-bar"><div class="fill" style="width:${progress}%;background:var(--tag-${color})"></div></div>
            <span class="progress-label">${progress}%${remaining > 0 ? ` · ${remaining} tasks left` : ''}</span>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  // Sidebar projects
  const sidebarProjects = document.getElementById('sidebar-projects');
  sidebarProjects.innerHTML = DATA.projects.map(p => {
    const icon = getIcon(p.icon);
    const taskCount = DATA.tasks.filter(t => t.project_id === p.id && t.status !== 'Done').length;
    return `<div class="sidebar-item" onclick="showProject('${p.id}');this.parentElement.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));this.classList.add('active')">
      <span class="ic"><svg><use href="${icon}"/></svg></span> ${p.name}
      ${taskCount ? `<span class="badge">${taskCount}</span>` : ''}
    </div>`;
  }).join('');

  // Recent tasks
  renderTaskList(DATA.tasks.slice(0, 8), 'tasks-list');
}

function renderTaskList(tasks, containerId) {
  const container = document.getElementById(containerId);
  if (tasks.length === 0) {
    container.innerHTML = `<div class="empty-state"><h3>No tasks yet</h3><p>Add tasks in the Google Sheet → Tasks tab</p></div>`;
    return;
  }
  // Sort: in-progress first, then todo, then done
  const order = {'In Progress':0, 'To Do':1, 'Review':2, 'Done':3};
  const sorted = [...tasks].sort((a,b) => (order[a.status]||1) - (order[b.status]||1));
  
  container.innerHTML = `<div class="task-list">${sorted.map(t => {
    const isDone = t.status === 'Done';
    const statusClass = t.status === 'In Progress' ? 'in-progress' : t.status === 'Done' ? 'done' : t.status === 'Review' ? 'review' : 'todo';
    const project = DATA.projects.find(p => p.id === t.project_id);
    const assigneeColor = t.assigned_to === 'Omer' ? 'var(--accent)' : 'var(--info)';
    const assigneeInitial = t.assigned_to ? t.assigned_to.charAt(0) : '?';
    return `<div class="task-row">
      <div class="task-check${isDone?' done':''}">
        ${isDone ? '<svg style="width:11px;height:11px;stroke:#fff;stroke-width:3;fill:none"><use href="#i-check"/></svg>' : ''}
      </div>
      <div class="task-info">
        <div class="task-name${isDone?' completed':''}">${t.name}</div>
        <div class="task-meta">${project ? project.name : (t.project_id || '')}</div>
      </div>
      <div class="task-assignee" style="background:${assigneeColor}">${assigneeInitial}</div>
      <div class="task-status ${statusClass}">${t.status || 'To Do'}</div>
      <div class="task-due">${t.due_date || ''}</div>
    </div>`;
  }).join('')}</div>`;
}

function showProject(projectId) {
  const project = DATA.projects.find(p => p.id === projectId);
  if (!project) return;
  
  document.getElementById('project-title').textContent = project.name;
  document.getElementById('project-desc').textContent = project.description || '';
  document.getElementById('bc').textContent = project.name;
  
  const projectTasks = DATA.tasks.filter(t => t.project_id === projectId);
  renderTaskList(projectTasks, 'project-tasks');
  
  // Switch screen
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('s-project').classList.add('active');
  document.querySelector('.content').scrollTop = 0;
}

// ============================================
// NAVIGATION
// ============================================
const PAGE_NAMES = {dashboard:'Dashboard'};

function nav(id, el) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('s-' + id).classList.add('active');
  document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
  if (el) el.classList.add('active');
  document.getElementById('bc').textContent = PAGE_NAMES[id] || 'Dashboard';
  document.querySelector('.content').scrollTop = 0;
}

// ============================================
// INIT
// ============================================
loadAllData();
</script>
</body>
</html>